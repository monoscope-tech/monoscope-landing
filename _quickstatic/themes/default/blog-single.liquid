{% render "default/components/head", this:this, config:config %}
{% render "default/components/nav", this:this, config:config %}

<!-- Reading Progress Indicator -->
<div class="reading-progress" aria-hidden="true"></div>

<!-- Floating Share Buttons (desktop only) -->
<div class="share-floating" id="floatingShare">
  <a href="https://www.twitter.com/share?url=https://monoscope.tech{{ this.permalink }}&text={{ this.frontmatter.title }}"
     target="_blank" rel="noopener noreferrer"
     title="Share on X"
     class="group p-3 bg-bgRaised hover:bg-fillBrand-weak rounded-full border border-strokeWeak shadow-sm transition-all duration-200 hover:scale-110">
    <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#x-twitter"></use></svg>
  </a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://monoscope.tech{{ this.permalink }}&title={{ this.frontmatter.title }}"
     target="_blank" rel="noopener noreferrer"
     title="Share on LinkedIn"
     class="group p-3 bg-bgRaised hover:bg-fillBrand-weak rounded-full border border-strokeWeak shadow-sm transition-all duration-200 hover:scale-110">
    <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#linkedin"></use></svg>
  </a>
  <a href="https://www.reddit.com/submit?url=https://monoscope.tech{{ this.permalink }}&title={{ this.frontmatter.title }}"
     target="_blank" rel="noopener noreferrer"
     title="Share on Reddit"
     class="group p-3 bg-bgRaised hover:bg-fillBrand-weak rounded-full border border-strokeWeak shadow-sm transition-all duration-200 hover:scale-110">
    <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#reddit-alien"></use></svg>
  </a>
  <button onclick="copyToClipboard('https://monoscope.tech{{ this.permalink }}')"
          title="Copy link"
          class="group p-3 bg-bgRaised hover:bg-fillBrand-weak rounded-full border border-strokeWeak shadow-sm transition-all duration-200 hover:scale-110">
    <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/sprite.svg#link"></use></svg>
  </button>
</div>

<main>
  <!-- Hero Section -->
  <div class="w-full bg-gradient-to-b from-fillWeak to-transparent">
    <div class="max-w-4xl mx-auto px-3 pt-32 pb-16">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-textWeak mb-8">
        <a href="/" class="hover:text-textBrand transition-colors">Home</a>
        <svg class="w-4 h-4 opacity-50"><use xlink:href="/assets/deps/sprite.svg#chevron-right"></use></svg>
        <a href="/blog/" class="hover:text-textBrand transition-colors">Blog</a>
        <svg class="w-4 h-4 opacity-50"><use xlink:href="/assets/deps/sprite.svg#chevron-right"></use></svg>
        <span class="text-textStrong">Article</span>
      </nav>

      <!-- Article Header -->
      <header class="space-y-6">
        <!-- Category Badge -->
        {% if this.frontmatter.categories %}
          <div class="flex flex-wrap gap-2">
            {% for category in this.frontmatter.categories %}
              <a href="/blog/categories/{{ category | slugify }}" 
                 class="inline-flex items-center px-3 py-1 bg-fillBrand-weak text-textBrand rounded-full text-sm font-medium hover:bg-fillBrand-strong hover:text-textInverse-strong transition-colors">
                {{ category }}
              </a>
            {% endfor %}
          </div>
        {% elsif this.frontmatter.categoties %}
          <div class="flex flex-wrap gap-2">
            {% for category in this.frontmatter.categoties %}
              <a href="/blog/categories/{{ category | slugify }}" 
                 class="inline-flex items-center px-3 py-1 bg-fillBrand-weak text-textBrand rounded-full text-sm font-medium hover:bg-fillBrand-strong hover:text-textInverse-strong transition-colors">
                {{ category }}
              </a>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Title -->
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-normal leading-tight text-textStrong">
          {{ this.frontmatter.title }}
        </h1>

        <!-- Meta Information -->
        <div class="flex flex-wrap items-center gap-6 text-textWeak">
          {% if this.frontmatter.author %}
            {% assign author = config.raw.authors[this.frontmatter.author] %}
            <div class="flex items-center gap-3">
              <img class="w-12 h-12 rounded-full border-2 border-strokeWeak" 
                   src="{{ author.picture }}" 
                   alt="{{ author.name }}">
              <div>
                <p class="text-textStrong font-medium">{{ author.name }}</p>
                {% if author.role %}
                  <p class="text-sm">{{ author.role }}</p>
                {% endif %}
              </div>
            </div>
            <span class="hidden sm:block w-px h-8 bg-strokeWeak"></span>
          {% endif %}
          
          <time class="text-sm font-medium" datetime="{{ this.frontmatter.date }}">
            {{ this.frontmatter.date | date: "%B %d, %Y" }}
          </time>
          
          <span class="hidden sm:block w-px h-8 bg-strokeWeak"></span>
          <span class="text-sm font-medium" data-reading-time>{% if this.frontmatter.readingTime %}{{ this.frontmatter.readingTime }} min read{% endif %}</span>
        </div>
      </header>
    </div>
  </div>

  <!-- Featured Image -->
  {% if this.frontmatter.featured_image %}
    <div class="max-w-6xl mx-auto px-3 -mt-8 mb-16">
      <img src="{{ this.permalink }}{{ this.frontmatter.featured_image }}" 
           alt="{{ this.frontmatter.title }}"
           class="w-full aspect-video object-cover rounded-2xl shadow-xl border border-strokeWeak">
    </div>
  {% endif %}

  <!-- Article Content with TOC -->
  <div class="max-w-8xl mx-auto px-3">
    <div class="flex gap-8 justify-center">
      <!-- Main Article -->
      <article class="max-w-4xl w-full" id="articleContent">
        <div class="prose prose-lg prose-gray dark:prose-invert mx-auto
                    prose-headings:font-normal prose-headings:text-textStrong
                    prose-h1:text-3xl prose-h1:sm:text-4xl prose-h1:mb-8 prose-h1:mt-12
                    prose-h2:text-2xl prose-h2:sm:text-3xl prose-h2:mb-6 prose-h2:mt-10
                    prose-h3:text-xl prose-h3:sm:text-2xl prose-h3:mb-4 prose-h3:mt-8
                    prose-p:text-textWeak prose-p:leading-relaxed prose-p:mb-6
                    prose-a:text-textBrand prose-a:underline prose-a:underline-offset-2 hover:prose-a:text-fillBrand-strong
                    prose-strong:text-textStrong prose-strong:font-semibold
                    prose-code:text-textBrand prose-code:bg-fillBrand-weak prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:before:content-[''] prose-code:after:content-['']
                    prose-pre:bg-fillWeak prose-pre:border prose-pre:border-strokeWeak prose-pre:shadow-sm
                    prose-blockquote:border-l-4 prose-blockquote:border-strokeBrand-strong prose-blockquote:bg-fillBrand-weak prose-blockquote:py-1 prose-blockquote:px-6 prose-blockquote:italic
                    prose-img:rounded-xl prose-img:shadow-lg prose-img:border prose-img:border-strokeWeak
                    prose-ul:list-disc prose-ul:pl-6 prose-ul:space-y-2
                    prose-ol:list-decimal prose-ol:pl-6 prose-ol:space-y-2
                    prose-li:text-textWeak prose-li:leading-relaxed
                    prose-table:border prose-table:border-strokeWeak prose-table:rounded-lg prose-table:overflow-hidden
                    prose-th:bg-fillWeak prose-th:font-semibold prose-th:text-textStrong
                    prose-td:border-t prose-td:border-strokeWeak">

          {{ this.content }}

        </div>
      </article>

      <!-- Sticky TOC (hidden on mobile and tablets) -->
      <aside class="hidden xl:block w-56 flex-shrink-0">
        <nav class="sticky top-24">
          <h4 class="text-xs font-semibold text-textDisabled mb-4 uppercase tracking-wider">On this page</h4>
          <ul id="blogTableOfContents" class="space-y-1 text-sm"></ul>
        </nav>
      </aside>
    </div>
  </div>

  <!-- Share Section -->
  <div class="max-w-4xl mx-auto px-3 mt-16 mb-8">
    <div class="border-t border-strokeWeak pt-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
        <!-- Share Buttons -->
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-textWeak">Share this article:</span>
          <div class="flex items-center gap-2">
            <!-- X/Twitter -->
            <a href="https://www.twitter.com/share?url=https://monoscope.tech{{ this.permalink }}&text={{ this.frontmatter.title }}" 
               target="_blank" rel="noopener noreferrer"
               title="Share on X"
               class="group p-2 bg-fillWeak hover:bg-fillBrand-weak rounded-lg transition-all duration-200 hover:scale-110">
              <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#x-twitter"></use></svg>
            </a>

            <!-- LinkedIn -->
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://monoscope.tech{{ this.permalink }}&title={{ this.frontmatter.title }}"
               target="_blank" rel="noopener noreferrer"
               title="Share on LinkedIn"
               class="group p-2 bg-fillWeak hover:bg-fillBrand-weak rounded-lg transition-all duration-200 hover:scale-110">
              <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#linkedin"></use></svg>
            </a>

            <!-- Reddit -->
            <a href="https://www.reddit.com/submit?url=https://monoscope.tech{{ this.permalink }}&title={{ this.frontmatter.title }}" 
               target="_blank" rel="noopener noreferrer"
               title="Share on Reddit"
               class="group p-2 bg-fillWeak hover:bg-fillBrand-weak rounded-lg transition-all duration-200 hover:scale-110">
              <svg class="w-5 h-5 text-textWeak group-hover:text-textBrand"><use xlink:href="/assets/deps/fontawesome/brands.svg#reddit-alien"></use></svg>
            </a>
          </div>
        </div>

        <!-- Copy Link Button -->
        <button onclick="copyToClipboard('https://monoscope.tech{{ this.permalink }}')" 
                class="flex items-center gap-2 px-4 py-2 bg-fillWeak hover:bg-fillBrand-weak text-textWeak hover:text-textBrand rounded-lg transition-colors group">
          <svg class="w-4 h-4"><use xlink:href="/assets/deps/sprite.svg#link"></use></svg>
          <span class="text-sm font-medium">Copy link</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Author Bio Section -->
  {% if this.frontmatter.author %}
    {% assign author = config.raw.authors[this.frontmatter.author] %}
    <div class="max-w-4xl mx-auto px-3 mb-16">
      <div class="bg-fillWeak rounded-2xl p-8 border border-strokeWeak">
        <div class="flex flex-col sm:flex-row gap-6">
          <img class="w-20 h-20 rounded-full border-2 border-strokeBrand-weak" 
               src="{{ author.picture }}" 
               alt="{{ author.name }}">
          <div class="flex-1 space-y-3">
            <div>
              <h3 class="text-xl font-semibold text-textStrong">{{ author.name }}</h3>
              {% if author.role %}
                <p class="text-textWeak">{{ author.role }}</p>
              {% endif %}
            </div>
            {% if author.bio %}
              <p class="text-textWeak leading-relaxed">{{ author.bio }}</p>
            {% endif %}
            {% if author.social %}
              <div class="flex items-center gap-3 pt-2">
                {% if author.social.twitter %}
                  <a href="{{ author.social.twitter }}" target="_blank" rel="noopener noreferrer" 
                     class="text-textWeak hover:text-textBrand transition-colors">
                    <svg class="w-5 h-5"><use xlink:href="/assets/deps/fontawesome/brands.svg#x-twitter"></use></svg>
                  </a>
                {% endif %}
                {% if author.social.linkedin %}
                  <a href="{{ author.social.linkedin }}" target="_blank" rel="noopener noreferrer"
                     class="text-textWeak hover:text-textBrand transition-colors">
                    <svg class="w-5 h-5"><use xlink:href="/assets/deps/fontawesome/brands.svg#linkedin"></use></svg>
                  </a>
                {% endif %}
                {% if author.social.github %}
                  <a href="{{ author.social.github }}" target="_blank" rel="noopener noreferrer"
                     class="text-textWeak hover:text-textBrand transition-colors">
                    <svg class="w-5 h-5"><use xlink:href="/assets/deps/fontawesome/brands.svg#github"></use></svg>
                  </a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Newsletter Signup Section -->
  <div class="max-w-4xl mx-auto px-3 mb-16">
    <div class="bg-gradient-to-br from-fillBrand-weak to-fillWeak rounded-2xl p-8 border border-strokeBrand-weak text-center">
      <h3 class="text-2xl font-semibold text-textStrong mb-3">Stay Updated</h3>
      <p class="text-textWeak mb-6">
        Signup for our <a data-formkit-toggle="e05f719e6e" href="https://monoscope.kit.com/e05f719e6e" class="text-textBrand underline underline-offset-2 hover:text-fillBrand-strong transition-colors cursor-pointer">newsletter</a> to stay updated with the latest insights on API monitoring and observability.
      </p>
    </div>
  </div>

  <!-- Related Articles -->
  <section class="bg-fillWeak border-t border-strokeWeak">
    <div class="max-w-8xl mx-auto px-3 py-16">
      <h2 class="text-3xl font-normal text-textStrong mb-8">Related articles</h2>
      
      {% assign all_posts = file_list | where_glob: 'file_path', "./blog/*/index.md" | sort: "date" %}
      {% assign related_posts = "" | split: "," %}
      
      {% if this.frontmatter.categories %}
        {% assign current_categories = this.frontmatter.categories %}
      {% elsif this.frontmatter.categoties %}
        {% assign current_categories = this.frontmatter.categoties %}
      {% else %}
        {% assign current_categories = "" | split: "," %}
      {% endif %}
      
      {% for post in all_posts %}
        {% if post.permalink != this.permalink %}
          {% assign has_common_category = false %}
          
          {% if post.frontmatter.categories %}
            {% assign post_categories = post.frontmatter.categories %}
          {% elsif post.frontmatter.categoties %}
            {% assign post_categories = post.frontmatter.categoties %}
          {% else %}
            {% assign post_categories = "" | split: "," %}
          {% endif %}
          
          {% for cat in current_categories %}
            {% if post_categories contains cat %}
              {% assign has_common_category = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          
          {% if has_common_category %}
            {% assign related_posts = related_posts | push: post %}
          {% endif %}
        {% endif %}
        
        {% if related_posts.size >= 3 %}
          {% break %}
        {% endif %}
      {% endfor %}
      
      <!-- If not enough related posts, just show recent posts -->
      {% if related_posts.size < 3 %}
        {% for post in all_posts limit: 3 %}
          {% if post.permalink != this.permalink %}
            {% assign related_posts = related_posts | push: post %}
          {% endif %}
        {% endfor %}
      {% endif %}
      
      <div class="grid gap-8 grid-cols-1 md:grid-cols-3">
        {% for post in related_posts limit: 3 %}
          <article class="blog-card group rounded-xl p-4 -m-4">
            <a href="{{ post.permalink }}" class="block space-y-3">
              <div class="blog-card-image rounded-xl overflow-hidden">
                {% if post.frontmatter.featured_image %}
                  <img src="{{ post.permalink }}{{ post.frontmatter.featured_image }}"
                       alt="{{ post.frontmatter.title }}"
                       class="w-full aspect-video object-cover border border-strokeWeak">
                {% else %}
                  <div class="w-full aspect-video bg-gradient-to-br from-fillBrand-weak to-fillWeak border border-strokeWeak"></div>
                {% endif %}
              </div>

              <div class="space-y-2">
                <h3 class="text-lg font-medium text-textStrong group-hover:text-textBrand transition-colors line-clamp-2">
                  {{ post.frontmatter.title }}
                </h3>
                <p class="text-sm text-textWeak line-clamp-2">
                  {{ post.markdown_body | markdownify | strip_html | truncatewords: 20, "..." }}
                </p>
                <div class="flex items-center justify-between pt-2">
                  <time class="text-xs text-textDisabled">
                    {{ post.frontmatter.date | date: "%B %d, %Y" }}
                  </time>
                  <span class="text-xs font-medium text-textBrand group-hover:underline">
                    Read more â†’
                  </span>
                </div>
              </div>
            </a>
          </article>
        {% endfor %}
      </div>
    </div>
  </section>

</main>

<!-- Copy to clipboard script -->
<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    const button = event.currentTarget;
    const span = button.querySelector('span');
    button.classList.add('copy-success');
    if (span) {
      const originalText = span.textContent;
      span.textContent = 'Copied!';
      setTimeout(() => {
        span.textContent = originalText;
        button.classList.remove('copy-success');
      }, 2000);
    } else {
      setTimeout(() => button.classList.remove('copy-success'), 2000);
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const article = document.getElementById('articleContent');
  const toc = document.getElementById('blogTableOfContents');
  const floatingShare = document.getElementById('floatingShare');
  const readingTimeEl = document.querySelector('[data-reading-time]');
  const progressBar = document.querySelector('.reading-progress');

  // Dynamic reading time calculation
  if (article && readingTimeEl && !readingTimeEl.textContent.trim()) {
    const words = article.textContent.trim().split(/\s+/).length;
    const minutes = Math.ceil(words / 200);
    readingTimeEl.textContent = minutes + ' min read';
  }

  // Build TOC from h2 and h3 headings
  if (article && toc) {
    const prose = article.querySelector('.prose');
    if (prose) {
      const headings = prose.querySelectorAll('h2, h3');
      headings.forEach((heading, i) => {
        if (!heading.id) heading.id = 'heading-' + i;
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        if (heading.tagName === 'H3') {
          a.classList.add('toc-h3');
        }
        li.appendChild(a);
        toc.appendChild(li);
      });

      // IntersectionObserver for active TOC highlighting
      if (headings.length > 0) {
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                toc.querySelectorAll('a').forEach(link => link.classList.remove('active'));
                const active = toc.querySelector(`a[href="#${entry.target.id}"]`);
                if (active) active.classList.add('active');
              }
            });
          },
          { rootMargin: '-80px 0px -80% 0px', threshold: 0 }
        );
        headings.forEach(heading => observer.observe(heading));
      }
    }
  }

  // Floating share buttons visibility
  if (floatingShare) {
    const hero = document.querySelector('.bg-gradient-to-b');
    if (hero) {
      const shareObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              floatingShare.classList.remove('visible');
            } else {
              floatingShare.classList.add('visible');
            }
          });
        },
        { threshold: 0 }
      );
      shareObserver.observe(hero);
    }
  }

  // Reading progress bar fallback for browsers without scroll-timeline
  if (progressBar && !CSS.supports('animation-timeline', 'scroll()')) {
    progressBar.style.animation = 'none';
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      const height = document.documentElement.scrollHeight - window.innerHeight;
      progressBar.style.transform = `scaleX(${Math.min(scrolled / height, 1)})`;
    }, { passive: true });
  }
});
</script>

{% render "default/components/foot", this:this %}
